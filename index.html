<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🚛 Food Safety Adventure – Transport Edition</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/qrious@4.0.2/dist/qrious.min.js"></script>
  <style>
    :root {
      --primary: #1B5E20; /* dark green */
      --primary-600: #0D4A14;
      --secondary: #8D6E63; /* coffee brown */
      --accent: #A1887F; /* light coffee */
      --muted: #E8E8E8; /* light silver */
      --ink: #2E2E2E;
      --ink-soft: #5D4E37;
      --paper: #ffffff;
      --success-bg: #E8F5E9; /* subtle green */
      --danger-bg: #FDECEA; /* subtle red */
      --success-border: #4CAF50;
      --danger-border: #F44336;
      --header-bg: #1B5E20;
      --footer-bg: #8D6E63;
    }

    html, body { height: 100%; }
    html { font-size: 112%; } /* Reduced by 20% from 140% */
    body {
      font-family: 'Arial', 'Helvetica', sans-serif;
      margin: 0;
      padding: 0;
      color: var(--ink);
      background: linear-gradient(135deg, #E8E8E8 0%, #D2B48C 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(90deg, var(--header-bg), var(--secondary));
      color: white;
      padding: 1.5rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
    header img { height: 56px; }
    header h1 {
      flex-grow: 1;
      text-align: center;
      margin: 0;
      font-family: 'Arial', sans-serif;
      font-size: 48px; /* Reduced by 20% from 60px */
      letter-spacing: .5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 2rem 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 2.5rem;
      background: var(--paper);
      border-radius: 25px;
      box-shadow:
        0 12px 40px rgba(0,0,0,0.15),
        0 4px 12px rgba(0,0,0,0.1);
      border: 3px solid var(--accent);
      position: relative;
      overflow: hidden;
      flex: 1;
    }
    
    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #2E7D32, #43A047, #66BB6A, #81C784);
    }

    /* Per-category theme ring for the whole question box */
    #quizBox.qtheme-cool { box-shadow: 0 0 0 6px #1e88e533 inset, 0 1px 0 #00000008, 0 6px 14px rgba(0,0,0,0.10), 0 18px 40px rgba(0,0,0,0.08); }
    #quizBox.qtheme-clean { box-shadow: 0 0 0 6px #00acc133 inset, 0 1px 0 #00000008, 0 6px 14px rgba(0,0,0,0.10), 0 18px 40px rgba(0,0,0,0.08); }
    #quizBox.qtheme-transport { box-shadow: 0 0 0 6px #43A04733 inset, 0 1px 0 #00000008, 0 6px 14px rgba(0,0,0,0.10), 0 18px 40px rgba(0,0,0,0.08); }
    #quizBox.qtheme-pack { box-shadow: 0 0 0 6px #8D6E6333 inset, 0 1px 0 #00000008, 0 6px 14px rgba(0,0,0,0.10), 0 18px 40px rgba(0,0,0,0.08); }
    #quizBox.qtheme-label { box-shadow: 0 0 0 6px #F57C0033 inset, 0 1px 0 #00000008, 0 6px 14px rgba(0,0,0,0.10), 0 18px 40px rgba(0,0,0,0.08); }

    /* Remove gradients: keep a clean solid surface */
    #quizBox.qtheme-cool,
    #quizBox.qtheme-clean,
    #quizBox.qtheme-transport,
    #quizBox.qtheme-pack,
    #quizBox.qtheme-label { background-image: none; background: var(--paper); }

    .question {
      font-family: 'Arial', sans-serif;
      font-size: 36px; /* Reduced by 20% from 45px */
      color: var(--ink);
      margin-bottom: 2rem; /* Reduced by 20% */
      display: flex;
      align-items: center;
      gap: 12px; /* Reduced by 20% */
      line-height: 1.5;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      padding: 1.2rem; /* Reduced by 20% */
      background: linear-gradient(135deg, #E8E8E8, #D2B48C);
      border-radius: 16px; /* Reduced by 20% */
      border: 2px solid var(--accent);
    }
    .question::before { content: ''; }
    .qicon { display:none; }
    .qicon.cool { color: #1e88e5; }
    .qicon.clean { color: #00acc1; }
    .qicon.transport { color: #43A047; }
    .qicon.pack { color: #8D6E63; }
    .qicon.label { color: #F57C00; }

    .qbadge {
      display: inline-block;
      margin-right: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      font-size: 0.65em;
      vertical-align: middle;
      border: 2px solid #00000012;
      background: #fff;
    }
    .qbadge.cool { background: #bbdefb; color: #0d47a1; }
    .qbadge.clean { background: #b2ebf2; color: #006064; }
    .qbadge.transport { background: #c8e6c9; color: #1b5e20; }
    .qbadge.pack { background: #e1bee7; color: #4a148c; }
    .qbadge.label { background: #ffe0b2; color: #e65100; }

    .options { list-style: none; padding: 0; margin: 0; }
    .options li {
      position: relative;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      margin: 1rem 0; /* Reduced by 20% */
      padding: 1.4rem 1.6rem; /* Reduced by 20% */
      border-radius: 16px; /* Reduced by 20% */
      cursor: pointer;
      font-size: 1.04em; /* Reduced by 20% from 1.3em */
      font-family: 'Arial', sans-serif;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 5px 14px rgba(0,0,0,0.1), 0 2px 5px rgba(0,0,0,0.06);
      border: 2px solid var(--accent); /* Reduced by 20% */
      transform: translateY(0);
    }
    
    .options li::before {
      content: '📋';
      margin-left: 10px; /* Reduced by 20% */
      font-size: 1.2em; /* Reduced by 20% */
    }
    .options li:hover { 
      transform: translateY(-3px) scale(1.02); 
      box-shadow: 0 8px 25px rgba(0,0,0,0.15), 0 4px 8px rgba(0,0,0,0.08);
      border-color: #2E7D32;
    }
    .options li::before { content: ''; }
    .options li.correct {
      background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
      border-color: #4CAF50;
      color: #1B5E20;
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
    }
    
    .options li.correct::before {
      content: '🎉';
      font-size: 2em;
    }
    .options li.incorrect {
      background: linear-gradient(135deg, #FDECEA 0%, #FFCDD2 100%);
      border-color: #F44336;
      color: #C62828;
      transform: scale(0.98);
    }
    
    .options li.incorrect::before {
      content: '😔';
      font-size: 2em;
    }

    #score {
      margin-top: 1rem;
      font-weight: 700;
      color: #1d3b2f;
      text-align: center;
      background: linear-gradient(90deg, #fff, #f9f9f9);
      border-radius: 10px;
      padding: 8px 12px;
      border: 2px solid #e8e8e8;
      display: inline-block;
      min-width: 220px;
      font-size: 1em;
    }

    #certificate {
      display: none;
      text-align: center;
      padding: 2rem 1.2rem 3rem;
    }
    #certificate .card {
      margin: 0 auto;
      max-width: 1000px;
      background: #ffffff;
      border-radius: 12px;
      padding: 2rem 2.5rem;
      border: 1px solid #D8DFE3;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      position: relative;
    }
    #certificate .ribbon { display:none; }
    #certificate h2 {
      color: var(--secondary);
      font-size: 34px;
      font-family: 'Merriweather', serif;
      letter-spacing: .5px;
      margin-bottom: 0.5rem;
    }
    #certificate button {
      margin-top: 1rem;
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.65rem 1.25rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 8px 16px rgba(0,0,0,0.12);
    }

    /* Certificate footer */
    .cert-footer {
      display: flex;
      justify-content: space-between;
      gap: 24px;
      margin-top: 28px;
      padding-top: 16px;
      border-top: 1px solid #E0E6EA;
    }
    .sig-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }
    .sig-text {
      color: var(--secondary);
      font-weight: 600;
      margin-bottom: 10px;
    }
    .sig-line {
      height: 1px;
      background: #B0BEC5;
      margin-top: 18px;
    }
    .sig-label {
      color: var(--ink-soft);
      font-size: 0.85em;
      margin-top: 6px;
    }

    footer {
      background: linear-gradient(90deg, var(--footer-bg), var(--accent));
      color: white;
      padding: 1.5rem 2rem;
      text-align: center;
      box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
    
    footer p {
      margin: 0;
      font-size: 1.1em;
      font-family: 'Cairo', sans-serif;
    }

    .nav {
      background: #ffffff;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 -6px 16px rgba(0,0,0,0.06);
      margin-top: 2rem;
    }
    .nav button {
      background: #fff;
      color: #2E4A3B;
      border: 3px solid #00000014;
      padding: 0.6rem 1.1rem;
      margin: 0 0.4rem;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 900;
      font-family: 'Cairo', sans-serif;
      font-size: 1em;
      box-shadow: 0 3px 0 #00000010, 0 10px 16px rgba(0,0,0,0.08);
      transition: transform .08s ease;
    }
    .nav button:hover { transform: translateY(-1px); }
    .nav button:active { transform: translateY(2px); }

    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 3px solid var(--accent);
      border-radius: 20px;
      padding: 2.5rem;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      z-index: 200;
      text-align: center;
      background-image: none;
    }
    .modal h3 { 
      margin-top: 0; 
      color: var(--primary); 
      font-family: 'Amiri', serif; 
      font-size: 40px; 
      margin-bottom: 1.5rem;
    }
    .modal p {
      font-size: 1.4em;
      line-height: 1.6;
      margin-bottom: 2rem;
      color: var(--ink);
    }
    .modal button {
      margin-top: 1rem;
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 1rem 2rem;
      border-radius: 15px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1.2em;
      transition: all 0.3s ease;
    }
    .modal button:hover {
      background: var(--primary-600);
      transform: scale(1.05);
    }

    /* Certificate/Print adjustments */
    body.certificate-mode header img { height: 28px; }
    body.certificate-mode .nav { display: none; }
    @media print {
      @page { size: A4 landscape; margin: 10mm; }
      body { background: #fff !important; }
      header { box-shadow: none; }
      header img { height: 24px !important; }
      .nav, #score { display: none !important; }
      #certificate { display: block !important; }
      #quizBox, .modal { display: none !important; }
      #certificate .card { max-width: 100%; box-shadow: none; border-width: 6px; }
    }

    /* Educational Content Box */
    .edu-content {
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      border: 2px solid #2196F3;
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      box-shadow: 0 6px 20px rgba(33, 150, 243, 0.15);
      position: relative;
      overflow: hidden;
    }
    
    .edu-content::before {
      content: '🎓';
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 2em;
      opacity: 0.3;
    }
    
    .edu-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 1rem;
      font-family: 'Amiri', serif;
      font-size: 1.4em;
      font-weight: 700;
      color: #1565C0;
    }
    
    .edu-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 1rem;
    }
    
    .edu-tab {
      padding: 8px 16px;
      background: rgba(255,255,255,0.7);
      border: 2px solid #2196F3;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 0.9em;
    }
    
    .edu-tab.active {
      background: #2196F3;
      color: white;
      transform: scale(1.05);
    }
    
    .edu-tab:hover {
      background: #1976D2;
      color: white;
      transform: translateY(-2px);
    }
    
    .edu-content-area {
      min-height: 200px;
      background: rgba(255,255,255,0.8);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid rgba(33, 150, 243, 0.2);
    }
    
    .video-placeholder {
      background: linear-gradient(135deg, #FF6B6B, #4ECDC4);
      border-radius: 12px;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-family: 'Amiri', serif;
      font-size: 1.2em;
      font-weight: 700;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .video-placeholder::before {
      content: '▶️';
      font-size: 3em;
      margin-left: 10px;
    }
    
    .video-placeholder:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .infographic-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .info-card {
      background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
      border: 2px solid #FF9800;
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .info-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(255, 152, 0, 0.3);
    }
    
    .info-icon {
      font-size: 2.5em;
      margin-bottom: 0.5rem;
    }
    
    .info-title {
      font-family: 'Amiri', serif;
      font-weight: 700;
      color: #E65100;
      margin-bottom: 0.5rem;
    }
    
    .info-desc {
      font-family: 'Cairo', sans-serif;
      font-size: 0.9em;
      color: #BF360C;
      line-height: 1.4;
    }
    
    /* Auto-advance feature */
    .auto-advance {
      background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
      border: 2px solid #4CAF50;
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
      text-align: center;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      color: #1B5E20;
    }
    
    .countdown {
      font-size: 1.5em;
      font-weight: 700;
      color: #2E7D32;
      margin: 0.5rem 0;
    }
    
    /* Progress bar */
    .progress-container {
      background: rgba(255,255,255,0.3);
      border-radius: 10px;
      height: 8px;
      margin: 1rem 0;
      overflow: hidden;
    }
    
    .progress-bar {
      background: linear-gradient(90deg, #2E7D32, #4CAF50, #66BB6A);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 10px;
    }
    
    /* Animations */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    .slide-in {
      animation: slideInUp 0.6s ease-out;
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
<header>
  <img src="logo-left.png" alt="Left Logo" />
  <h1>🚛 Food Safety Adventure – Transport Edition</h1>
  <img src="logo-right.png" alt="Right Logo" />
</header>

<div class="main-content">
  <div class="container" id="quizBox">
  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  
  <!-- Educational Content Box -->
  <div class="edu-content" id="eduContent">
    <div class="edu-header">
      <span>🎓</span>
      <span>Educational Content</span>
    </div>
    <div class="edu-tabs">
      <div class="edu-tab active" onclick="switchEduTab('video')">📹 Educational Video</div>
      <div class="edu-tab" onclick="switchEduTab('info')">📊 Information</div>
      <div class="edu-tab" onclick="switchEduTab('tips')">💡 Tips</div>
    </div>
    <div class="edu-content-area" id="eduContentArea">
      <!-- Content will be loaded dynamically -->
    </div>
  </div>
  
  <div class="question" id="question"></div>
  <ul class="options" id="options"></ul>
  
  <!-- Auto-advance notification -->
  <div class="auto-advance" id="autoAdvance" style="display: none;">
    <div>⏰ Auto-advancing to next question in:</div>
    <div class="countdown" id="countdown">5</div>
  </div>
  
  <div style="text-align:center"><div id="score">📊 Score: 0 / 0</div></div>
  </div>
</div>

<div id="certificate">
  <div class="card">
    <div class="ribbon">🎉 Congratulations! 🎉</div>
    <h2>🎓 Certificate of Completion</h2>
    <p>This certifies that <strong id="userName">John</strong> has successfully completed</p>
    <p><em>Food Safety Transport Training</em></p>
    <p>Final Score: <strong id="finalScore">0/0</strong></p>
    <div id="categoryStats" style="margin-top:12px"></div>
    <div id="certMeta" style="margin-top:8px; color:#556; font-size:.9rem; display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap">
      <canvas id="certQr" width="96" height="96" style="border:1px solid #E0E6EA; border-radius:6px; background:#fff"></canvas>
    </div>
    <div class="cert-footer">
      <div class="sig-block">
        <div class="sig-text">Sharjah City Municipality – Health Control and Safety Department</div>
        <div class="sig-line"></div>
        <div class="sig-label">Authorized Signature</div>
      </div>
      <div class="sig-block" style="max-width: 260px; align-items:flex-end;">
        <div class="sig-text" id="certDate">—</div>
        <div class="sig-line" style="width:100%"></div>
        <div class="sig-label">Date</div>
      </div>
    </div>
    <div style="margin-top:12px; display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap">
      <button onclick="window.print()">🖨️ Print Certificate</button>
      <button id="resetBtn" type="button" style="background:#fff;color:#2F3A3B;border:1px solid #CBD5E1">↺ Reset Quiz</button>
    </div>
  </div>
  </div>

  <div class="nav">
    <button onclick="prevQuestion()">⬅️ Previous</button>
    <button onclick="nextQuestion()">Next ➡️</button>
  </div>
</div>

<footer>
  <p>© 2024 Sharjah City Municipality – Health Control and Safety Department | All Rights Reserved</p>
</footer>

<div class="modal" id="feedbackModal">
  <h3>💡 Tip</h3>
  <p id="modalContent"></p>
  <button onclick="closeModal()">Continue</button>
  </div>
<script>
  let quizzes = [];
  let current = 0;
  let score = 0;
  let answered = {};
  let answeredCorrect = {};
  let autoAdvanceTimer = null;
  let currentEduTab = 'video';

  function seedFallbackQuizzes() {
    return [
      {
        id: 1,
        question: 'What is the safest temperature for transporting perishable food?',
        options: ['0-5°C', '10-15°C', '20-25°C', 'Any temperature'],
        answer: 0,
        explanation: 'Cold chain food should generally be kept at 0-5°C to prevent bacterial growth.'
      },
      {
        id: 2,
        question: 'Which practice reduces cross-contamination during transport?',
        options: ['Mix raw and cooked foods', 'Separate sealed containers', 'No labels needed', 'Use same tools'],
        answer: 1,
        explanation: 'Separate sealed containers and labeling help avoid cross-contamination.'
      },
      {
        id: 3,
        question: 'What should be done before loading food?',
        options: ['Ignore vehicle cleanliness', 'Sanitize vehicle surfaces', 'Turn off refrigeration', 'Skip checks'],
        answer: 1,
        explanation: 'Sanitizing reduces contamination risk; ensure refrigeration is functional before loading.'
      }
    ];
  }

  fetch('quizzes.json')
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(data => {
      quizzes = data.quizzes || seedFallbackQuizzes();
      showQuestion();
      updateScore();
    })
    .catch(() => {
      quizzes = seedFallbackQuizzes();
      showQuestion();
      updateScore();
    });

  function showQuestion() {
    const q = quizzes[current];
    if (!q) return;
    
    // Update progress bar
    updateProgressBar();
    
    // Load educational content
    loadEducationalContent(q);
    
    const manualType = normalizeType(q.category);
    const type = manualType || detectType(q.question);
    const icon = '';
    const qEl = document.getElementById('question');
    const badge = type ? `<span class="qbadge ${type}">${type}</span>` : '';
    qEl.innerHTML = `${badge} Level ${q.id}: ${q.question}`;
    qEl.classList.add('slide-in');
    
    const box = document.getElementById('quizBox');
    box.classList.remove('qtheme-cool','qtheme-clean','qtheme-transport','qtheme-pack','qtheme-label');
    if (type) box.classList.add(`qtheme-${type}`);
    
    const optionsList = document.getElementById('options');
    optionsList.innerHTML = '';

    q.options.forEach((opt, i) => {
      const li = document.createElement('li');
      li.textContent = opt;
      li.onclick = () => {
        if (answered[current]) return;
        answered[current] = true;
        
        // Clear auto-advance timer
        if (autoAdvanceTimer) {
          clearTimeout(autoAdvanceTimer);
          autoAdvanceTimer = null;
        }
        document.getElementById('autoAdvance').style.display = 'none';
        
        if (i === q.answer) {
          li.classList.add('correct');
          score++;
          answeredCorrect[current] = true;
          showCelebration();
        } else {
          li.classList.add('incorrect');
          if (optionsList.children[q.answer]) {
            optionsList.children[q.answer].classList.add('correct');
          }
          answeredCorrect[current] = false;
          showDisappointment();
        }
        updateScore();
        
        // Show tip immediately
        setTimeout(() => {
          const tipText = `✅ Correct Answer: ${q.options[q.answer]}\n💬 ${q.explanation}`;
          document.getElementById('modalContent').textContent = tipText;
          document.getElementById('feedbackModal').style.display = 'block';
        }, 1000);
      };
      optionsList.appendChild(li);
    });
  }

  function detectType(text) {
    const t = (text || '').toLowerCase();
    if (/(temp|cold|chill|cool|°|c|cold chain|freeze|refriger)/.test(t)) return 'cool';
    if (/(sanitize|clean|hygiene|wash|disinfect|cleanliness)/.test(t)) return 'clean';
    if (/(transport|truck|deliver|vehicle|load|unload|route)/.test(t)) return 'transport';
    if (/(pack|seal|container|package|wrap|box)/.test(t)) return 'pack';
    if (/(label|expiry|date|trace|tag)/.test(t)) return 'label';
    return '';
  }

  function detectIcon(text) {
    const t = (text || '').toLowerCase();
    if (/(temp|cold|chill|cool|°|c|cold chain|freeze|refriger)/.test(t)) return '🧊';
    if (/(sanitize|clean|hygiene|wash|disinfect|sanitize|cleanliness)/.test(t)) return '🧼';
    if (/(transport|truck|deliver|vehicle|load|unload|route)/.test(t)) return '🚚';
    if (/(pack|seal|container|package|wrap|box)/.test(t)) return '🥡';
    if (/(label|expiry|date|trace|tag)/.test(t)) return '🏷️';
    return '🍽️';
  }

  function normalizeType(category) {
    if (!category) return '';
    const t = String(category).toLowerCase().trim();
    if (/^(temp|cold|cool|chill|freeze|refriger|temperature|cold\s*chain)$/.test(t)) return 'cool';
    if (/^(clean|cleaning|hygiene|wash|sanitize|sanitization|disinfect)$/.test(t)) return 'clean';
    if (/^(transport|delivery|vehicle|logistics|route|loading)$/.test(t)) return 'transport';
    if (/^(pack|packaging|seal|container|boxing|wrapping)$/.test(t)) return 'pack';
    if (/^(label|labelling|labeling|expiry|expiration|trace|traceability|tag)$/.test(t)) return 'label';
    return '';
  }

  function iconForType(type) {
    switch (type) {
      case 'cool': return '🧊';
      case 'clean': return '🧼';
      case 'transport': return '🚚';
      case 'pack': return '🥡';
      case 'label': return '🏷️';
      default: return '🍽️';
    }
  }

  function nextQuestion() {
    if (current < quizzes.length - 1) {
      current++;
      showQuestion();
    } else {
      showCertificate();
    }
  }

  function closeModal() {
    document.getElementById('feedbackModal').style.display = 'none';
    nextQuestion();
  }

  function prevQuestion() {
    if (current > 0) {
      current--;
      showQuestion();
    }
  }

  function updateScore() {
    const el = document.getElementById('score');
    if (el) el.textContent = `📊 Score: ${score} / ${quizzes.length}`;
  }
  
  function updateProgressBar() {
    const progress = ((current + 1) / quizzes.length) * 100;
    const progressBar = document.getElementById('progressBar');
    if (progressBar) {
      progressBar.style.width = progress + '%';
    }
  }
  
  function loadEducationalContent(question) {
    const type = normalizeType(question.category) || detectType(question.question);
    const contentArea = document.getElementById('eduContentArea');
    
    if (currentEduTab === 'video') {
      contentArea.innerHTML = `
        <div class="video-placeholder" onclick="playVideo('${type}')">
          <div>
            <div>Watch Educational Video</div>
            <div style="font-size: 0.8em; margin-top: 5px; opacity: 0.9;">
              ${getVideoTitle(type)}
            </div>
          </div>
        </div>
      `;
    } else if (currentEduTab === 'info') {
      contentArea.innerHTML = `
        <div class="infographic-content">
          ${getInfographicContent(type)}
        </div>
      `;
    } else if (currentEduTab === 'tips') {
      contentArea.innerHTML = `
        <div style="font-family: 'Arial', sans-serif; line-height: 1.6;">
          <h4 style="color: #1565C0; margin-bottom: 1rem;">💡 Important Tips:</h4>
          ${getTipsContent(type)}
        </div>
      `;
    }
  }
  
  function switchEduTab(tab) {
    currentEduTab = tab;
    
    // Update tab styles
    document.querySelectorAll('.edu-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
    
    // Reload content
    const q = quizzes[current];
    if (q) loadEducationalContent(q);
  }
  
  function getVideoTitle(type) {
    const titles = {
      'cool': 'Temperature Control',
      'clean': 'Hygiene and Sanitization',
      'transport': 'Safe Food Transport',
      'pack': 'Packaging and Wrapping',
      'label': 'Labeling and Documentation'
    };
    return titles[type] || 'General Food Safety';
  }
  
  function getInfographicContent(type) {
    const content = {
      'cool': `
        <div class="info-card">
          <div class="info-icon">🧊</div>
          <div class="info-title">Temperature</div>
          <div class="info-desc">0-5°C for chilled foods<br>-18°C for frozen foods</div>
        </div>
        <div class="info-card">
          <div class="info-icon">🌡️</div>
          <div class="info-title">Monitoring</div>
          <div class="info-desc">Check every 2 hours<br>Record readings</div>
        </div>
        <div class="info-card">
          <div class="info-icon">❄️</div>
          <div class="info-title">Refrigeration</div>
          <div class="info-desc">Proper cooling units<br>Good thermal insulation</div>
        </div>
      `,
      'clean': `
        <div class="info-card">
          <div class="info-icon">🧼</div>
          <div class="info-title">Cleaning</div>
          <div class="info-desc">Daily thorough cleaning<br>Use sanitizing materials</div>
        </div>
        <div class="info-card">
          <div class="info-icon">🦠</div>
          <div class="info-title">Prevent Contamination</div>
          <div class="info-desc">Separate raw foods<br>Use separate tools</div>
        </div>
        <div class="info-card">
          <div class="info-icon">👨‍🍳</div>
          <div class="info-title">Personal Hygiene</div>
          <div class="info-desc">Wash hands<br>Wear gloves</div>
        </div>
      `,
      'transport': `
        <div class="info-card">
          <div class="info-icon">🚚</div>
          <div class="info-title">Vehicle</div>
          <div class="info-desc">Regular maintenance<br>Thorough cleaning</div>
        </div>
        <div class="info-card">
          <div class="info-icon">📦</div>
          <div class="info-title">Loading</div>
          <div class="info-desc">Proper arrangement<br>Prevent damage</div>
        </div>
        <div class="info-card">
          <div class="info-icon">⏰</div>
          <div class="info-title">Time</div>
          <div class="info-desc">Quick delivery<br>Avoid delays</div>
        </div>
      `
    };
    return content[type] || content['transport'];
  }
  
  function getTipsContent(type) {
    const tips = {
      'cool': `
        <ul style="list-style: none; padding: 0;">
          <li>❄️ Ensure cooling equipment works before loading</li>
          <li>🌡️ Monitor temperature every 2 hours</li>
          <li>📝 Record all readings in log</li>
          <li>🚨 In case of malfunction, transfer goods immediately</li>
        </ul>
      `,
      'clean': `
        <ul style="list-style: none; padding: 0;">
          <li>🧼 Clean vehicle before and after each trip</li>
          <li>🦠 Use approved sanitizing materials</li>
          <li>👥 Train workers on personal hygiene</li>
          <li>📋 Keep cleaning records</li>
        </ul>
      `,
      'transport': `
        <ul style="list-style: none; padding: 0;">
          <li>🚛 Ensure vehicle is roadworthy</li>
          <li>📦 Arrange goods by priority</li>
          <li>🛣️ Choose shortest safe route</li>
          <li>⏰ Avoid peak hours</li>
        </ul>
      `
    };
    return tips[type] || tips['transport'];
  }
  
  function playVideo(type) {
    alert(`Educational video will play about: ${getVideoTitle(type)}\n\n(This is an example - can be linked to a real video from YouTube or any other platform)`);
  }
  
  function showCelebration() {
    // Create celebration elements
    const celebration = document.createElement('div');
    celebration.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4em;
      z-index: 1000;
      pointer-events: none;
      animation: celebrationPop 2s ease-out forwards;
    `;
    celebration.innerHTML = '🎉✨🎊';
    
    // Add celebration animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes celebrationPop {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(celebration);
    setTimeout(() => {
      document.body.removeChild(celebration);
      document.head.removeChild(style);
    }, 2000);
  }
  
  function showDisappointment() {
    // Create disappointment element
    const disappointment = document.createElement('div');
    disappointment.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3em;
      z-index: 1000;
      pointer-events: none;
      animation: disappointmentShake 1.5s ease-out forwards;
    `;
    disappointment.innerHTML = '😔💔';
    
    // Add disappointment animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes disappointmentShake {
        0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        25% { opacity: 1; transform: translate(-50%, -50%) scale(1.1) rotate(-5deg); }
        50% { transform: translate(-50%, -50%) scale(1) rotate(5deg); }
        75% { transform: translate(-50%, -50%) scale(1.1) rotate(-3deg); }
        100% { opacity: 0; transform: translate(-50%, -50%) scale(1) rotate(0deg); }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(disappointment);
    setTimeout(() => {
      document.body.removeChild(disappointment);
      document.head.removeChild(style);
    }, 1500);
  }
  
  function startAutoAdvance() {
    let countdown = 3;
    const countdownEl = document.getElementById('countdown');
    const autoAdvanceEl = document.getElementById('autoAdvance');
    
    autoAdvanceEl.style.display = 'block';
    
    const timer = setInterval(() => {
      countdownEl.textContent = countdown;
      countdown--;
      
      if (countdown < 0) {
        clearInterval(timer);
        autoAdvanceEl.style.display = 'none';
        nextQuestion();
      }
    }, 1000);
    
    autoAdvanceTimer = timer;
  }

  function showCertificate() {
    document.getElementById('quizBox').style.display = 'none';
    document.getElementById('finalScore').textContent = `${score} / ${quizzes.length}`;
    document.getElementById('certificate').style.display = 'block';
    document.body.classList.add('certificate-mode');
    renderCategoryStats();
    const d = new Date();
    const dateStr = d.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    const dateEl = document.getElementById('certDate');
    if (dateEl) dateEl.textContent = dateStr;
    const certId = generateCertificateId();
    const meta = document.getElementById('certMeta');
    const verifyUrl = `${window.location.origin}/verify?cert=${encodeURIComponent(certId)}`;
    if (meta) {
      // prepend text label and verify link before QR canvas
      const label = document.createElement('span');
      label.textContent = `Certificate ID: ${certId}`;
      const link = document.createElement('a');
      link.href = verifyUrl;
      link.target = '_blank';
      link.rel = 'noopener noreferrer';
      link.textContent = 'Verify Online';
      link.style.marginLeft = '8px';
      meta.prepend(label);
      meta.prepend(link);
    }
    renderQr(verifyUrl);
    
  }

  function burstConfetti(count = 50) {
    const colors = [
      'var(--clown-red)', 'var(--clown-yellow)', 'var(--clown-green)', 'var(--clown-blue)', 'var(--clown-purple)'
    ];
    for (let i = 0; i < count; i++) {
      const piece = document.createElement('div');
      piece.className = 'confetti';
      piece.style.left = Math.random() * 100 + 'vw';
      piece.style.background = colors[Math.floor(Math.random() * colors.length)];
      piece.style.transform = `translateY(-20px) rotate(${Math.random()*360}deg)`;
      const duration = 2.4 + Math.random() * 1.6;
      piece.style.animationDuration = duration + 's';
      piece.style.opacity = (0.7 + Math.random()*0.3).toFixed(2);
      piece.style.width = (6 + Math.random()*8) + 'px';
      piece.style.height = (8 + Math.random()*12) + 'px';
      document.body.appendChild(piece);
      setTimeout(() => piece.remove(), duration * 1000);
    }
  }

  function renderCategoryStats() {
    const counters = { cool: { c: 0, t: 0, icon: '🧊', label: 'Cold Chain' }, clean: { c: 0, t: 0, icon: '🧼', label: 'Hygiene' }, transport: { c: 0, t: 0, icon: '🚚', label: 'Transport' }, pack: { c: 0, t: 0, icon: '🥡', label: 'Packaging' }, label: { c: 0, t: 0, icon: '🏷️', label: 'Labeling' } };
    quizzes.forEach((q, idx) => {
      const manual = normalizeType(q.category);
      const type = manual || detectType(q.question);
      const key = counters[type] ? type : null;
      if (!key) return;
      counters[key].t += 1;
      if (answeredCorrect[idx] === true) counters[key].c += 1;
    });
    const container = document.getElementById('categoryStats');
    const order = ['cool','clean','transport','pack','label'];
    const parts = order
      .filter(k => counters[k].t > 0)
      .map(k => {
        const { c, t, icon, label } = counters[k];
        return `<span style="display:inline-flex;align-items:center;gap:6px;margin:4px 8px;padding:6px 10px;border-radius:999px;background:#ffffffcc;border:1px solid #00000012">${icon} <strong>${label}</strong> <span style="opacity:.8">${c}/${t}</span></span>`;
      });
    container.innerHTML = parts.join('');
  }

  function generateCertificateId() {
    const rnd = Math.random().toString(36).slice(2, 8).toUpperCase();
    const ts = Date.now().toString(36).toUpperCase().slice(-6);
    return `${ts}-${rnd}`;
  }

  function renderQr(text) {
    try {
      const canvas = document.getElementById('certQr');
      if (!canvas || typeof QRious === 'undefined') return;
      new QRious({ element: canvas, value: text, size: 96, level: 'H', background: 'white', foreground: '#222' });
    } catch (_) {}
  }

  // Reset quiz flow
  document.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'resetBtn') {
      resetQuiz();
    }
  });

  function resetQuiz() {
    current = 0;
    score = 0;
    answered = {};
    answeredCorrect = {};
    document.getElementById('certificate').style.display = 'none';
    document.getElementById('quizBox').style.display = 'block';
    document.body.classList.remove('certificate-mode');
    showQuestion();
    updateScore();
  }

  // Basic RTL auto-detect (Arabic locales)
  (function applyRTL() {
    try {
      const lang = (navigator.language || navigator.userLanguage || 'en').toLowerCase();
      if (lang.startsWith('ar')) {
        document.documentElement.setAttribute('dir', 'rtl');
      }
    } catch (_) {}
  })();
</script>
</body>
</html>


